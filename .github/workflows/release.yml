name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  verify:
    name: Verify (lint, typecheck, test)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          # Expo / RN toolchains are most reliable on the current Node LTS.
          node-version: "20"
          cache: "npm"
          cache-dependency-path: CommercePrototype/package-lock.json

      - name: Install dependencies
        run: |
          if [ -f CommercePrototype/package-lock.json ]; then
            cd CommercePrototype && npm ci
          else
            cd CommercePrototype && npm install
          fi

      - name: Lint
        run: cd CommercePrototype && npm run lint

      - name: Typecheck
        run: cd CommercePrototype && npx tsc --noEmit

      - name: Run tests
        run: cd CommercePrototype && npm test -- --runInBand

  build_web:
    name: Build web export
    runs-on: ubuntu-latest
    needs: verify
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          # Expo / RN toolchains are most reliable on the current Node LTS.
          node-version: "20"
          cache: "npm"
          cache-dependency-path: CommercePrototype/package-lock.json

      - name: Install dependencies
        run: |
          if [ -f CommercePrototype/package-lock.json ]; then
            cd CommercePrototype && npm ci
          else
            cd CommercePrototype && npm install
          fi

      - name: Export web (dist/)
        env:
          # Provide a production API URL at build time if available in secrets
          EXPO_PUBLIC_API_URL: ${{ secrets.PROD_API_URL }}
        run: |
          cd CommercePrototype
          if [ -z "$EXPO_PUBLIC_API_URL" ]; then
            EXPO_PUBLIC_API_URL="http://localhost:5035"
          fi
          npm run web:export

      - name: Inspect export output (debug)
        run: |
          cd CommercePrototype
          echo "Contents of CommercePrototype:" && ls -la
          if [ -d dist ]; then
            echo "dist exists; listing contents:" && ls -la dist
          else
            echo "dist not found after export"
          fi

      - name: Package web artifact (dist or fallback source)
        run: |
          cd CommercePrototype
          if [ ! -d dist ]; then
            echo "dist not found after export" >&2
            exit 1
          fi
          tar -czf web-dist.tgz dist
          echo "packaged dist -> web-dist.tgz"

      - name: Prepare web release asset
        run: |
          cp CommercePrototype/web-dist.tgz ./web-dist.tgz

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: |
            web-dist.tgz

  build_backend:
    name: Build & publish backend
    runs-on: ubuntu-latest
    needs: verify
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "8.0.x"

      - name: Build and publish backend
        run: |
          cd CommercePrototype-Backend
          dotnet restore
          dotnet build -c Release
          dotnet publish -c Release -o ./publish

      - name: Inject SFCC production settings into publish/
        env:
          SFCC_API_BASE_URL: ${{ secrets.SFCC_API_BASE_URL }}
          SFCC_CLIENT_ID: ${{ secrets.SFCC_CLIENT_ID }}
          SFCC_API_VERSION: ${{ secrets.SFCC_API_VERSION }}
          SFCC_INSTANCE_NAME: ${{ secrets.SFCC_INSTANCE_NAME }}
          SFCC_OAUTH_TOKEN_URL: ${{ secrets.SFCC_OAUTH_TOKEN_URL }}
        run: |
          if [ -z "$SFCC_API_BASE_URL" ] || [ -z "$SFCC_CLIENT_ID" ]; then
            echo "::warning::Missing SFCC secrets (SFCC_API_BASE_URL or SFCC_CLIENT_ID). Skipping appsettings.Production.json injection; backend will require env vars at runtime."
            exit 0
          fi
          cd CommercePrototype-Backend/publish
          python3 - <<'PY'
          import json
          import os

          api_base_url = os.environ.get("SFCC_API_BASE_URL")
          client_id = os.environ.get("SFCC_CLIENT_ID")
          api_version = os.environ.get("SFCC_API_VERSION") or "v20_4"
          instance_name = os.environ.get("SFCC_INSTANCE_NAME") or ""
          oauth_token_url = os.environ.get("SFCC_OAUTH_TOKEN_URL") or ""

          data = {
              "Sfcc": {
                  "ApiBaseUrl": api_base_url,
                  "ClientId": client_id,
                  "ApiVersion": api_version,
                  "InstanceName": instance_name,
                  "OAuthTokenUrl": oauth_token_url,
              }
          }

          with open("appsettings.Production.json", "w", encoding="utf-8") as f:
              json.dump(data, f, indent=2)
              f.write("\n")
          PY
          echo "Wrote appsettings.Production.json into publish/"

      - name: Package backend artifact
        run: |
          cd CommercePrototype-Backend
          tar -czf backend-publish.tgz publish

      - name: Prepare backend release asset
        run: cp CommercePrototype-Backend/backend-publish.tgz ./backend-publish.tgz

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-publish
          path: backend-publish.tgz

  export_android:
    name: Export Android project (prebuild)
    runs-on: ubuntu-latest
    needs: verify
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          # Expo / RN toolchains are most reliable on the current Node LTS.
          node-version: "20"
          cache: "npm"
          cache-dependency-path: CommercePrototype/package-lock.json

      - name: Install frontend deps
        run: |
          cd CommercePrototype
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Prebuild android project (expo prebuild)
        run: |
          cd CommercePrototype
          npx expo prebuild --platform android --no-install

      - name: Package android project
        run: |
          # Package the FULL Expo project (including App.tsx/app/assets) + the generated android/ folder.
          # IMPORTANT: the archive is flattened so that, after extraction, you can run:
          #   npm ci
          #   npx expo start --android
          # from the extracted folder root.
          if [ ! -d CommercePrototype/android ]; then echo "CommercePrototype/android not found" >&2; exit 1; fi
          if [ ! -f CommercePrototype/package.json ]; then echo "CommercePrototype/package.json not found" >&2; exit 1; fi
          if [ ! -f CommercePrototype/app.json ]; then echo "CommercePrototype/app.json not found" >&2; exit 1; fi
          if [ ! -f CommercePrototype/App.tsx ] && [ ! -f CommercePrototype/App.js ] && [ ! -f CommercePrototype/App.ts ]; then
            echo "No App entrypoint found (expected App.tsx/App.ts/App.js)" >&2
            exit 1
          fi
          if [ ! -f CommercePrototype/assets/images/icon.png ]; then
            echo "Missing icon asset at CommercePrototype/assets/images/icon.png" >&2
            exit 1
          fi

          tar -czf android-project.tgz \
            -C CommercePrototype \
            --exclude='node_modules' \
            --exclude='.expo' \
            --exclude='dist' \
            .

      - name: Prepare android release asset
        run: ls -la ./android-project.tgz

      - name: Upload android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-project
          path: android-project.tgz

  github_release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build_web, build_backend, export_android]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure tag is on main
        run: |
          git fetch origin main --depth=50
          git merge-base --is-ancestor "$GITHUB_SHA" "origin/main"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release and attach artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/web-dist.tgz
            artifacts/backend-publish.tgz
            artifacts/android-project.tgz
          generate_release_notes: true
