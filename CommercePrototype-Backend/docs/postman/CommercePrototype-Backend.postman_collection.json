{
  "info": {
    "_postman_id": "2b412513-2e0b-4c0f-bd8a-7a6a3a9d45b7",
    "name": "CommercePrototype-Backend",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Smoke tests for CommercePrototype-Backend APIs (Auth, Cart/Baskets, Categories, Products).\n\nExpected local URLs from launchSettings.json: http://localhost:5035 or https://localhost:7270"
  },
  "item": [
    {
      "name": "Health",
      "item": [
        {
          "name": "GET /health",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/health",
              "host": ["{{baseUrl}}"],
              "path": ["health"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Catalog",
      "item": [
        {
          "name": "GET /api/categories?rootId=&levels=",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/categories?rootId={{categoryId}}&levels=2",
              "host": ["{{baseUrl}}"],
              "path": ["api", "categories"],
              "query": [
                { "key": "rootId", "value": "{{categoryId}}" },
                { "key": "levels", "value": "2" }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 200 or 404', function () {",
                  "  pm.expect([200, 404]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "GET /api/products (search)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/products?categoryId={{categoryId}}&q=&limit=24&offset=0",
              "host": ["{{baseUrl}}"],
              "path": ["api", "products"],
              "query": [
                { "key": "categoryId", "value": "{{categoryId}}" },
                { "key": "q", "value": "" },
                { "key": "limit", "value": "24" },
                { "key": "offset", "value": "0" }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 200 or 400', function () {",
                  "  pm.expect([200, 400]).to.include(pm.response.code);",
                  "});",
                  "// Optional: auto-pick a productId from the first hit if your response contains an array.",
                  "try {",
                  "  if (pm.response.code === 200) {",
                  "    const body = pm.response.json();",
                  "    const hits = body?.Hits || body?.hits || body?.Products || body?.products || body?.data || [];",
                  "    const first = Array.isArray(hits) ? hits[0] : null;",
                  "    const pid = first?.Id || first?.id || first?.ProductId || first?.productId;",
                  "    if (pid && !pm.environment.get('productId')) {",
                  "      pm.environment.set('productId', pid);",
                  "    }",
                  "  }",
                  "} catch (e) {}"
                ]
              }
            }
          ]
        },
        {
          "name": "GET /api/products/{id}",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/products/{{productId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "products", "{{productId}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 200 or 404', function () {",
                  "  pm.expect([200, 404]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Auth",
      "item": [
        {
          "name": "POST /api/auth/guest",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/auth/guest",
              "host": ["{{baseUrl}}"],
              "path": ["api", "auth", "guest"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "const body = pm.response.json();",
                  "pm.test('has sessionId', function () {",
                  "  pm.expect(body).to.have.property('sessionId');",
                  "});",
                  "if (body && body.sessionId) {",
                  "  pm.environment.set('shopperSessionId', body.sessionId);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "POST /api/auth/login",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"{{username}}\",\n  \"password\": \"{{password}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/login",
              "host": ["{{baseUrl}}"],
              "path": ["api", "auth", "login"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 200 or 401 or 400', function () {",
                  "  pm.expect([200, 401, 400]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code === 200) {",
                  "  const body = pm.response.json();",
                  "  if (body && body.sessionId) pm.environment.set('shopperSessionId', body.sessionId);",
                  "}"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Cart / Baskets",
      "item": [
        {
          "name": "POST /api/cart (create basket)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "X-Shopper-Session-Id", "value": "{{shopperSessionId}}", "disabled": false }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"currency\": \"EUR\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/cart",
              "host": ["{{baseUrl}}"],
              "path": ["api", "cart"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 201', function () {",
                  "  pm.response.to.have.status(201);",
                  "});",
                  "// If backend created/rotated the shopper session, it returns it in the response header",
                  "const sid = pm.response.headers.get('X-Shopper-Session-Id');",
                  "if (sid) pm.environment.set('shopperSessionId', sid);",
                  "const body = pm.response.json();",
                  "pm.test('has basketId', function () {",
                  "  pm.expect(body).to.have.property('basketId');",
                  "});",
                  "if (body && body.basketId) pm.environment.set('basketId', body.basketId);"
                ]
              }
            }
          ]
        },
        {
          "name": "GET /api/cart/{basketId}",
          "request": {
            "method": "GET",
            "header": [
              { "key": "X-Shopper-Session-Id", "value": "{{shopperSessionId}}" }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/cart/{{basketId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "cart", "{{basketId}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 200 or 404', function () {",
                  "  pm.expect([200, 404]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "POST /api/cart/{basketId}/items (add item)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "X-Shopper-Session-Id", "value": "{{shopperSessionId}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"productId\": \"{{productId}}\",\n  \"quantity\": 1\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/cart/{{basketId}}/items",
              "host": ["{{baseUrl}}"],
              "path": ["api", "cart", "{{basketId}}", "items"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 200 or 404 or 409', function () {",
                  "  pm.expect([200, 404, 409]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code === 200) {",
                  "  const body = pm.response.json();",
                  "  const items = body?.items || [];",
                  "  const pid = (pm.environment.get('productId') || '').toLowerCase();",
                  "  const match = Array.isArray(items) ? items.find(i => (i.productId || '').toLowerCase() === pid) : null;",
                  "  if (match && match.itemId) pm.environment.set('itemId', match.itemId);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "PATCH /api/cart/{basketId}/items/{itemId} (set quantity=2)",
          "request": {
            "method": "PATCH",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "X-Shopper-Session-Id", "value": "{{shopperSessionId}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"quantity\": 2\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/cart/{{basketId}}/items/{{itemId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "cart", "{{basketId}}", "items", "{{itemId}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 200 or 404 or 409', function () {",
                  "  pm.expect([200, 404, 409]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "DELETE /api/cart/{basketId}/items/{itemId} (remove item)",
          "request": {
            "method": "DELETE",
            "header": [
              { "key": "X-Shopper-Session-Id", "value": "{{shopperSessionId}}" }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/cart/{{basketId}}/items/{{itemId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "cart", "{{basketId}}", "items", "{{itemId}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 200 or 404', function () {",
                  "  pm.expect([200, 404]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "DELETE /api/cart/{basketId} (clear basket)",
          "request": {
            "method": "DELETE",
            "header": [
              { "key": "X-Shopper-Session-Id", "value": "{{shopperSessionId}}" }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/cart/{{basketId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "cart", "{{basketId}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 204 or 404', function () {",
                  "  pm.expect([204, 404]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "GET /api/cart/{basketId} (after clear, should 404)",
          "request": {
            "method": "GET",
            "header": [
              { "key": "X-Shopper-Session-Id", "value": "{{shopperSessionId}}" }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/cart/{{basketId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "cart", "{{basketId}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status is 404 (or 200 if SFCC keeps it)', function () {",
                  "  pm.expect([404, 200]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}
